<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .grade-1-5 { border-left: 4px solid #ef4444; }
        .grade-6-10 { border-left: 4px solid #f97316; }
        .grade-11-15 { border-left: 4px solid #eab308; }
        .grade-16-20 { border-left: 4px solid #22c55e; }
        .grade-21-25 { border-left: 4px solid #3b82f6; }
        .grade-26-30 { border-left: 4px solid #8b5cf6; }
        
        /* –î–∏–∑–∞–π–Ω –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã */
        .org-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-width: 100%;
        }
        
        .org-node {
            position: relative;
            margin: 10px;
            min-width: 280px;
            max-width: 400px;
        }
        
        .org-children {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            position: relative;
        }
        
        .org-children::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 20px;
            background-color: #6b7280;
        }
        
        .org-children .org-node::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background-color: #6b7280;
        }
        
        .org-children::after {
            content: '';
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #6b7280;
        }
        
        .org-children.single-child::after {
            display: none;
        }
        
        @media (max-width: 768px) {
            .org-children {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .org-node {
                min-width: 250px;
                max-width: 300px;
            }
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .excel-table th,
        .excel-table td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: left;
        }
        
        .excel-table th {
            background-color: #f3f4f6;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .excel-table input,
        .excel-table select {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</h1>
            
            <div class="flex flex-wrap gap-4 mb-6">
                <button onclick="addRootDepartment()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    + –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
                </button>
                <button onclick="toggleGradeView()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≥—Ä–µ–π–¥–∞–º
                </button>
                
                <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
                <div class="relative">
                    <button onclick="toggleExportMenu()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üì§ –≠–∫—Å–ø–æ—Ä—Ç
                    </button>
                    <div id="exportMenu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-20">
                        <button onclick="exportToJSON()" class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">JSON —Ñ–æ—Ä–º–∞—Ç</button>
                        <button onclick="exportToExcel()" class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Excel —Ñ–æ—Ä–º–∞—Ç</button>
                    </div>
                </div>
                
                <!-- –ò–º–ø–æ—Ä—Ç -->
                <div class="relative">
                    <button onclick="toggleImportMenu()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üì• –ò–º–ø–æ—Ä—Ç
                    </button>
                    <div id="importMenu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-20">
                        <label class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm cursor-pointer">
                            JSON —Ñ–∞–π–ª
                            <input type="file" id="importJSONFile" accept=".json" class="hidden" onchange="importFromJSON(event)">
                        </label>
                        <label class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm cursor-pointer">
                            Excel —Ñ–∞–π–ª
                            <input type="file" id="importExcelFile" accept=".xlsx,.xls" class="hidden" onchange="importFromExcel(event)">
                        </label>
                        <button onclick="showExcelTemplate()" class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">–°–æ–∑–¥–∞—Ç—å –∏–∑ —à–∞–±–ª–æ–Ω–∞ Excel</button>
                        <button onclick="downloadExcelTemplate()" class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">–°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-2">–õ–µ–≥–µ–Ω–¥–∞ –≥—Ä–µ–π–¥–æ–≤:</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-red-500 rounded"></div>
                            <span>1-5: –°—Ç–∞–∂–µ—Ä—ã/–ú–ª–∞–¥—à–∏–µ</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-orange-500 rounded"></div>
                            <span>6-10: –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                            <span>11-15: –°—Ç–∞—Ä—à–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-green-500 rounded"></div>
                            <span>16-20: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ –≥—Ä—É–ø–ø</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-blue-500 rounded"></div>
                            <span>21-25: –ú–µ–Ω–µ–¥–∂–µ—Ä—ã</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-purple-500 rounded"></div>
                            <span>26-30: –¢–æ–ø-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
                    <div id="statistics" class="text-sm space-y-1">
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>

        <div id="orgChart" class="bg-white rounded-lg shadow-lg p-6 min-h-96 overflow-auto">
            <div id="treeContainer" class="org-tree">
                <!-- –î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>

        <div id="gradeView" class="hidden bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≥—Ä–µ–π–¥–∞–º</h2>
            <div id="gradeGroups"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90vw max-h-90vh overflow-y-auto">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</h3>
            <form id="departmentForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</label>
                    <input type="text" id="deptName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</label>
                    <textarea id="deptDescription" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏</h4>
                        <button type="button" onclick="addPosition()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
                        </button>
                    </div>
                    <div id="positionsContainer" class="space-y-3 max-h-60 overflow-y-auto">
                        <!-- –ü–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</label>
                    <select id="deptHead" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∏–∑ –ø–æ–∑–∏—Ü–∏–π</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg font-medium transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ Excel —à–∞–±–ª–æ–Ω–∞ -->
    <div id="excelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-6xl max-h-90vh overflow-y-auto mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Excel —à–∞–±–ª–æ–Ω –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</h3>
                <button onclick="closeExcelModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é:</h4>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>‚Ä¢ <strong>ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è:</strong> –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 2, 3...)</li>
                    <li>‚Ä¢ <strong>ID —Ä–æ–¥–∏—Ç–µ–ª—è:</strong> –ù–æ–º–µ—Ä —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–ø—É—Å—Ç–æ–µ –¥–ª—è –∫–æ—Ä–Ω–µ–≤—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π)</li>
                    <li>‚Ä¢ <strong>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è:</strong> –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</li>
                    <li>‚Ä¢ <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
                    <li>‚Ä¢ <strong>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:</strong> –§–ò–û –∏–ª–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
                    <li>‚Ä¢ <strong>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏:</strong> –¢–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</li>
                    <li>‚Ä¢ <strong>–ì—Ä–µ–π–¥:</strong> –ß–∏—Å–ª–æ –æ—Ç 1 –¥–æ 30</li>
                    <li>‚Ä¢ <strong>–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:</strong> –ê–£–ü –∏–ª–∏ –ü–ü</li>
                    <li>‚Ä¢ <strong>–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:</strong> —à—Ç–∞—Ç –∏–ª–∏ –∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥</li>
                    <li>‚Ä¢ <strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> –ß–∏—Å–ª–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –¥–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏</li>
                </ul>
            </div>
            
            <div class="table-container mb-4">
                <table id="excelTable" class="excel-table">
                    <thead>
                        <tr>
                            <th>ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</th>
                            <th>ID —Ä–æ–¥–∏—Ç–µ–ª—è</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏</th>
                            <th>–ì—Ä–µ–π–¥</th>
                            <th>–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</th>
                            <th>–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        </tr>
                    </thead>
                    <tbody id="excelTableBody">
                        <!-- –°—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex gap-3">
                <button onclick="addExcelRow()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                    + –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                </button>
                <button onclick="importFromExcelTable()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
                <button onclick="exportExcelTable()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                    –°–∫–∞—á–∞—Ç—å –∫–∞–∫ Excel
                </button>
                <button onclick="closeExcelModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <script>
        let orgStructure = [];
        let currentEditId = null;
        let gradeViewActive = false;
        let excelData = [];

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getGradeClass(grade) {
            if (grade <= 5) return 'grade-1-5';
            if (grade <= 10) return 'grade-6-10';
            if (grade <= 15) return 'grade-11-15';
            if (grade <= 20) return 'grade-16-20';
            if (grade <= 25) return 'grade-21-25';
            return 'grade-26-30';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#exportMenu') && !e.target.closest('[onclick="toggleExportMenu()"]')) {
                document.getElementById('exportMenu').classList.add('hidden');
            }
            if (!e.target.closest('#importMenu') && !e.target.closest('[onclick="toggleImportMenu()"]')) {
                document.getElementById('importMenu').classList.add('hidden');
            }
        });

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
            document.getElementById('importMenu').classList.add('hidden');
        }

        function toggleImportMenu() {
            const menu = document.getElementById('importMenu');
            menu.classList.toggle('hidden');
            document.getElementById('exportMenu').classList.add('hidden');
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
        function exportToJSON() {
            try {
                const data = JSON.stringify(orgStructure, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `org-structure-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ JSON!');
                document.getElementById('exportMenu').classList.add('hidden');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ JSON: ' + error.message, 'error');
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        function exportToExcel() {
            try {
                const data = [];
                
                function flattenStructure(structure, parentId = '') {
                    structure.forEach(dept => {
                        if (dept.positions && dept.positions.length > 0) {
                            dept.positions.forEach(pos => {
                                data.push({
                                    'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': dept.id,
                                    'ID —Ä–æ–¥–∏—Ç–µ–ª—è': parentId,
                                    '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': dept.name,
                                    '–û–ø–∏—Å–∞–Ω–∏–µ': dept.description || '',
                                    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': dept.head || '',
                                    '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': pos.title,
                                    '–ì—Ä–µ–π–¥': pos.grade,
                                    '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': pos.personnelType,
                                    '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': pos.personnelKind,
                                    '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': pos.staffCount
                                });
                            });
                        } else {
                            data.push({
                                'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': dept.id,
                                'ID —Ä–æ–¥–∏—Ç–µ–ª—è': parentId,
                                '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': dept.name,
                                '–û–ø–∏—Å–∞–Ω–∏–µ': dept.description || '',
                                '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': dept.head || '',
                                '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': '',
                                '–ì—Ä–µ–π–¥': '',
                                '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '',
                                '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '',
                                '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': ''
                            });
                        }
                        
                        if (dept.children && dept.children.length > 0) {
                            flattenStructure(dept.children, dept.id);
                        }
                    });
                }
                
                flattenStructure(orgStructure);
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞");
                
                XLSX.writeFile(wb, `org-structure-${new Date().toISOString().split('T')[0]}.xlsx`);
                showNotification('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ Excel!');
                document.getElementById('exportMenu').classList.add('hidden');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ Excel: ' + error.message, 'error');
            }
        }

        // –ò–º–ø–æ—Ä—Ç –∏–∑ JSON
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (Array.isArray(importedData)) {
                        if (confirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                            orgStructure = importedData;
                            renderTree();
                            showNotification('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ JSON!');
                        }
                    } else {
                        showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON —Ñ–∞–π–ª–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π.', 'error');
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
            document.getElementById('importMenu').classList.add('hidden');
        }

        // –ò–º–ø–æ—Ä—Ç –∏–∑ Excel
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showNotification('Excel —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö', 'error');
                        return;
                    }
                    
                    if (confirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                        const newStructure = buildStructureFromExcel(jsonData);
                        if (newStructure) {
                            orgStructure = newStructure;
                            renderTree();
                            showNotification('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ Excel!');
                        }
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            
            event.target.value = '';
            document.getElementById('importMenu').classList.add('hidden');
        }

        function buildStructureFromExcel(data) {
            try {
                const departments = {};
                const departmentData = {};
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º
                data.forEach(row => {
                    const deptId = String(row['ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è'] || '').trim();
                    const parentId = String(row['ID —Ä–æ–¥–∏—Ç–µ–ª—è'] || '').trim();
                    const deptName = String(row['–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è'] || '').trim();
                    const description = String(row['–û–ø–∏—Å–∞–Ω–∏–µ'] || '').trim();
                    const head = String(row['–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'] || '').trim();
                    const positionTitle = String(row['–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏'] || '').trim();
                    const grade = parseInt(row['–ì—Ä–µ–π–¥']) || 1;
                    const personnelType = String(row['–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞'] || '–ê–£–ü').trim();
                    const personnelKind = String(row['–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞'] || '—à—Ç–∞—Ç').trim();
                    const staffCount = parseInt(row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ']) || 1;
                    
                    if (!deptId || !deptName) return;
                    
                    if (!departmentData[deptId]) {
                        departmentData[deptId] = {
                            id: generateId(),
                            originalId: deptId,
                            parentId: parentId,
                            name: deptName,
                            description: description,
                            head: head,
                            positions: [],
                            children: []
                        };
                    }
                    
                    if (positionTitle) {
                        departmentData[deptId].positions.push({
                            id: generateId(),
                            title: positionTitle,
                            grade: grade,
                            personnelType: personnelType,
                            personnelKind: personnelKind,
                            staffCount: staffCount
                        });
                    }
                });
                
                // –°—Ç—Ä–æ–∏–º –∏–µ—Ä–∞—Ä—Ö–∏—é
                const rootDepartments = [];
                const allDepartments = Object.values(departmentData);
                
                allDepartments.forEach(dept => {
                    dept.collapsed = false;
                    if (dept.parentId) {
                        const parent = allDepartments.find(d => d.originalId === dept.parentId);
                        if (parent) {
                            parent.children.push(dept);
                        } else {
                            rootDepartments.push(dept);
                        }
                    } else {
                        rootDepartments.push(dept);
                    }
                });
                
                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–æ–ª–µ originalId
                function cleanIds(structure) {
                    structure.forEach(dept => {
                        delete dept.originalId;
                        if (dept.children && dept.children.length > 0) {
                            cleanIds(dept.children);
                        }
                    });
                }
                
                cleanIds(rootDepartments);
                return rootDepartments;
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö Excel: ' + error.message, 'error');
                return null;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å Excel —à–∞–±–ª–æ–Ω
        function showExcelTemplate() {
            excelData = [
                {
                    deptId: '1',
                    parentId: '',
                    deptName: '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ü–∏—è',
                    description: '–í—ã—Å—à–∏–π –æ—Ä–≥–∞–Ω —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–µ–π',
                    head: '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                    positionTitle: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                    grade: '25',
                    personnelType: '–ê–£–ü',
                    personnelKind: '—à—Ç–∞—Ç',
                    staffCount: '1'
                },
                {
                    deptId: '2',
                    parentId: '1',
                    deptName: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                    description: '',
                    head: '',
                    positionTitle: '–ì–ª–∞–≤–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä',
                    grade: '20',
                    personnelType: '–ê–£–ü',
                    personnelKind: '—à—Ç–∞—Ç',
                    staffCount: '1'
                },
                {
                    deptId: '3',
                    parentId: '1',
                    deptName: 'IT –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                    description: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞',
                    head: 'IT –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                    positionTitle: 'IT –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                    grade: '25',
                    personnelType: '–ê–£–ü',
                    personnelKind: '—à—Ç–∞—Ç',
                    staffCount: '1'
                },
                {
                    deptId: '3',
                    parentId: '1',
                    deptName: 'IT –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                    description: '',
                    head: '',
                    positionTitle: '–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
                    grade: '18',
                    personnelType: '–ü–ü',
                    personnelKind: '—à—Ç–∞—Ç',
                    staffCount: '2'
                }
            ];
            
            document.getElementById('excelModal').classList.remove('hidden');
            renderExcelTable();
            document.getElementById('importMenu').classList.add('hidden');
        }

        function renderExcelTable() {
            const tbody = document.getElementById('excelTableBody');
            tbody.innerHTML = '';
            
            excelData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${row.deptId}" onchange="updateExcelData(${index}, 'deptId', this.value)"></td>
                    <td><input type="text" value="${row.parentId}" onchange="updateExcelData(${index}, 'parentId', this.value)"></td>
                    <td><input type="text" value="${row.deptName}" onchange="updateExcelData(${index}, 'deptName', this.value)"></td>
                    <td><input type="text" value="${row.description}" onchange="updateExcelData(${index}, 'description', this.value)"></td>
                    <td><input type="text" value="${row.head}" onchange="updateExcelData(${index}, 'head', this.value)"></td>
                    <td><input type="text" value="${row.positionTitle}" onchange="updateExcelData(${index}, 'positionTitle', this.value)"></td>
                    <td><input type="number" min="1" max="30" value="${row.grade}" onchange="updateExcelData(${index}, 'grade', this.value)"></td>
                    <td>
                        <select onchange="updateExcelData(${index}, 'personnelType', this.value)">
                            <option value="–ê–£–ü" ${row.personnelType === '–ê–£–ü' ? 'selected' : ''}>–ê–£–ü</option>
                            <option value="–ü–ü" ${row.personnelType === '–ü–ü' ? 'selected' : ''}>–ü–ü</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateExcelData(${index}, 'personnelKind', this.value)">
                            <option value="—à—Ç–∞—Ç" ${row.personnelKind === '—à—Ç–∞—Ç' ? 'selected' : ''}>—à—Ç–∞—Ç</option>
                            <option value="–∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥" ${row.personnelKind === '–∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥' ? 'selected' : ''}>–∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥</option>
                        </select>
                    </td>
                    <td><input type="number" min="1" value="${row.staffCount}" onchange="updateExcelData(${index}, 'staffCount', this.value)"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateExcelData(index, field, value) {
            if (excelData[index]) {
                excelData[index][field] = value;
            }
        }

        function addExcelRow() {
            excelData.push({
                deptId: '',
                parentId: '',
                deptName: '',
                description: '',
                head: '',
                positionTitle: '',
                grade: '1',
                personnelType: '–ê–£–ü',
                personnelKind: '—à—Ç–∞—Ç',
                staffCount: '1'
            });
            renderExcelTable();
        }

        function importFromExcelTable() {
            try {
                if (excelData.length === 0) {
                    showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', 'error');
                    return;
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                const convertedData = excelData.map(row => ({
                    'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': row.deptId,
                    'ID —Ä–æ–¥–∏—Ç–µ–ª—è': row.parentId,
                    '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': row.deptName,
                    '–û–ø–∏—Å–∞–Ω–∏–µ': row.description,
                    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': row.head,
                    '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': row.positionTitle,
                    '–ì—Ä–µ–π–¥': parseInt(row.grade) || 1,
                    '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': row.personnelType,
                    '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': row.personnelKind,
                    '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': parseInt(row.staffCount) || 1
                }));
                
                if (confirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    const newStructure = buildStructureFromExcel(convertedData);
                    if (newStructure) {
                        orgStructure = newStructure;
                        renderTree();
                        closeExcelModal();
                        showNotification('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã!');
                    }
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã: ' + error.message, 'error');
            }
        }

        function exportExcelTable() {
            try {
                const data = excelData.map(row => ({
                    'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': row.deptId,
                    'ID —Ä–æ–¥–∏—Ç–µ–ª—è': row.parentId,
                    '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': row.deptName,
                    '–û–ø–∏—Å–∞–Ω–∏–µ': row.description,
                    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': row.head,
                    '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': row.positionTitle,
                    '–ì—Ä–µ–π–¥': row.grade,
                    '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': row.personnelType,
                    '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': row.personnelKind,
                    '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': row.staffCount
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–®–∞–±–ª–æ–Ω —Å—Ç—Ä—É–∫—Ç—É—Ä—ã");
                
                XLSX.writeFile(wb, `template-org-structure-${new Date().toISOString().split('T')[0]}.xlsx`);
                showNotification('–®–∞–±–ª–æ–Ω Excel —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —à–∞–±–ª–æ–Ω–∞ Excel: ' + error.message, 'error');
            }
        }

        function downloadExcelTemplate() {
            try {
                const templateData = [
                    {
                        'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '1',
                        'ID —Ä–æ–¥–∏—Ç–µ–ª—è': '',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ü–∏—è',
                        '–û–ø–∏—Å–∞–Ω–∏–µ': '–í—ã—Å—à–∏–π –æ—Ä–≥–∞–Ω —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–µ–π',
                        '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                        '–ì—Ä–µ–π–¥': 30,
                        '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '–ê–£–ü',
                        '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '—à—Ç–∞—Ç',
                        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': 1
                    },
                    {
                        'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '2',
                        'ID —Ä–æ–¥–∏—Ç–µ–ª—è': '1',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                        '–û–ø–∏—Å–∞–Ω–∏–µ': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –∏ –±—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º',
                        '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                        '–ì—Ä–µ–π–¥': 25,
                        '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '–ê–£–ü',
                        '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '—à—Ç–∞—Ç',
                        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': 1
                    },
                    {
                        'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '2',
                        'ID —Ä–æ–¥–∏—Ç–µ–ª—è': '1',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                        '–û–ø–∏—Å–∞–Ω–∏–µ': '',
                        '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': '–ì–ª–∞–≤–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä',
                        '–ì—Ä–µ–π–¥': 20,
                        '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '–ê–£–ü',
                        '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '—à—Ç–∞—Ç',
                        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': 1
                    },
                    {
                        'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '3',
                        'ID —Ä–æ–¥–∏—Ç–µ–ª—è': '1',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': 'IT –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                        '–û–ø–∏—Å–∞–Ω–∏–µ': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞',
                        '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': 'IT –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': 'IT –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                        '–ì—Ä–µ–π–¥': 25,
                        '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '–ê–£–ü',
                        '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '—à—Ç–∞—Ç',
                        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': 1
                    },
                    {
                        'ID –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': '3',
                        'ID —Ä–æ–¥–∏—Ç–µ–ª—è': '1',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è': 'IT –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                        '–û–ø–∏—Å–∞–Ω–∏–µ': '',
                        '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '',
                        '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏': '–í–µ–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
                        '–ì—Ä–µ–π–¥': 18,
                        '–¢–∏–ø –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '–ü–ü',
                        '–í–∏–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': '—à—Ç–∞—Ç',
                        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': 2
                    }
                ];
                
                const ws = XLSX.utils.json_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–®–∞–±–ª–æ–Ω");
                
                XLSX.writeFile(wb, `template-org-structure.xlsx`);
                showNotification('–®–∞–±–ª–æ–Ω Excel —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');
                document.getElementById('importMenu').classList.add('hidden');
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞: ' + error.message, 'error');
            }
        }

        function closeExcelModal() {
            document.getElementById('excelModal').classList.add('hidden');
        }

        function addRootDepartment() {
            currentEditId = null;
            currentPositions = [];
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ';
            document.getElementById('departmentForm').reset();
            renderPositions();
            updateHeadOptions();
            document.getElementById('modal').classList.remove('hidden');
        }

        function addChildDepartment(parentId) {
            currentEditId = null;
            currentPositions = [];
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ';
            document.getElementById('departmentForm').reset();
            renderPositions();
            updateHeadOptions();
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').dataset.parentId = parentId;
        }

        function editDepartment(id) {
            const dept = findDepartmentById(id, orgStructure);
            if (dept) {
                currentEditId = id;
                document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ';
                document.getElementById('deptName').value = dept.name;
                document.getElementById('deptDescription').value = dept.description || '';
                
                currentPositions = dept.positions ? [...dept.positions] : [];
                renderPositions();
                updateHeadOptions();
                
                document.getElementById('deptHead').value = dept.head || '';
                document.getElementById('modal').classList.remove('hidden');
            }
        }

        function deleteDepartment(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏ –≤—Å–µ –µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è?')) {
                orgStructure = removeDepartmentById(id, orgStructure);
                renderTree();
                showNotification('–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ');
            }
        }

        function findDepartmentById(id, structure) {
            for (let dept of structure) {
                if (dept.id === id) return dept;
                if (dept.children) {
                    const found = findDepartmentById(id, dept.children);
                    if (found) return found;
                }
            }
            return null;
        }

        function removeDepartmentById(id, structure) {
            return structure.filter(dept => {
                if (dept.id === id) return false;
                if (dept.children) {
                    dept.children = removeDepartmentById(id, dept.children);
                }
                return true;
            });
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').removeAttribute('data-parent-id');
        }

        let currentPositions = [];

        function addPosition() {
            const positionId = generateId();
            const position = {
                id: positionId,
                title: '',
                grade: 1,
                personnelType: '–ê–£–ü',
                personnelKind: '—à—Ç–∞—Ç',
                staffCount: 1
            };
            currentPositions.push(position);
            renderPositions();
            updateHeadOptions();
        }

        function removePosition(positionId) {
            currentPositions = currentPositions.filter(p => p.id !== positionId);
            renderPositions();
            updateHeadOptions();
        }

        function updateHeadOptions() {
            const headSelect = document.getElementById('deptHead');
            const currentValue = headSelect.value;
            
            headSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∏–∑ –ø–æ–∑–∏—Ü–∏–π</option>';
            
            currentPositions.forEach(pos => {
                if (pos.title.trim()) {
                    const option = document.createElement('option');
                    option.value = pos.title;
                    option.textContent = pos.title;
                    headSelect.appendChild(option);
                }
            });
            
            if (currentValue && [...headSelect.options].some(opt => opt.value === currentValue)) {
                headSelect.value = currentValue;
            }
        }

        function renderPositions() {
            const container = document.getElementById('positionsContainer');
            if (currentPositions.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-4">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏</div>';
                return;
            }

            container.innerHTML = currentPositions.map(position => `
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                    <div class="flex justify-between items-start mb-3">
                        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏" value="${position.title}" 
                               onchange="updatePosition('${position.id}', 'title', this.value)"
                               class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm mr-2">
                        <button type="button" onclick="removePosition('${position.id}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                            ‚úï
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">–ì—Ä–µ–π–¥</label>
                            <input type="number" min="1" max="30" value="${position.grade}"
                                   onchange="updatePosition('${position.id}', 'grade', parseInt(this.value))"
                                   class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" min="1" value="${position.staffCount}"
                                   onchange="updatePosition('${position.id}', 'staffCount', parseInt(this.value))"
                                   class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">–¢–∏–ø</label>
                            <select onchange="updatePosition('${position.id}', 'personnelType', this.value)"
                                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="–ê–£–ü" ${position.personnelType === '–ê–£–ü' ? 'selected' : ''}>–ê–£–ü</option>
                                <option value="–ü–ü" ${position.personnelType === '–ü–ü' ? 'selected' : ''}>–ü–ü</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">–í–∏–¥</label>
                            <select onchange="updatePosition('${position.id}', 'personnelKind', this.value)"
                                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="—à—Ç–∞—Ç" ${position.personnelKind === '—à—Ç–∞—Ç' ? 'selected' : ''}>–®—Ç–∞—Ç</option>
                                <option value="–∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥" ${position.personnelKind === '–∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥' ? 'selected' : ''}>–ê—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥</option>
                            </select>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePosition(positionId, field, value) {
            const position = currentPositions.find(p => p.id === positionId);
            if (position) {
                position[field] = value;
                if (field === 'title') {
                    updateHeadOptions();
                }
            }
        }

        document.getElementById('departmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('deptName').value;
            const head = document.getElementById('deptHead').value;
            const description = document.getElementById('deptDescription').value;

            if (currentPositions.length === 0) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é –≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ', 'error');
                return;
            }

            const emptyPositions = currentPositions.filter(p => !p.title.trim());
            if (emptyPositions.length > 0) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π', 'error');
                return;
            }

            const department = {
                id: currentEditId || generateId(),
                name,
                head,
                description,
                positions: [...currentPositions],
                children: [],
                collapsed: false
            };

            if (currentEditId) {
                updateDepartment(currentEditId, department);
                showNotification('–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
            } else {
                const parentId = document.getElementById('modal').dataset.parentId;
                if (parentId) {
                    addToParent(parentId, department);
                } else {
                    orgStructure.push(department);
                }
                showNotification('–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
            }

            renderTree();
            closeModal();
        });

        function updateDepartment(id, newData) {
            function update(structure) {
                for (let dept of structure) {
                    if (dept.id === id) {
                        dept.name = newData.name;
                        dept.head = newData.head;
                        dept.description = newData.description;
                        dept.positions = newData.positions;
                        return true;
                    }
                    if (dept.children && update(dept.children)) {
                        return true;
                    }
                }
                return false;
            }
            update(orgStructure);
        }

        function addToParent(parentId, department) {
            function findAndAdd(structure) {
                for (let dept of structure) {
                    if (dept.id === parentId) {
                        if (!dept.children) dept.children = [];
                        dept.children.push(department);
                        return true;
                    }
                    if (dept.children && findAndAdd(dept.children)) {
                        return true;
                    }
                }
                return false;
            }
            findAndAdd(orgStructure);
        }

        function toggleCollapse(id) {
            function toggle(structure) {
                for (let dept of structure) {
                    if (dept.id === id) {
                        dept.collapsed = !dept.collapsed;
                        return true;
                    }
                    if (dept.children && toggle(dept.children)) {
                        return true;
                    }
                }
                return false;
            }
            toggle(orgStructure);
            renderTree();
        }

        function renderTree() {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '';
            
            if (orgStructure.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ" –¥–ª—è –Ω–∞—á–∞–ª–∞</div>';
                return;
            }

            orgStructure.forEach(dept => {
                const nodeElement = renderDepartment(dept);
                container.appendChild(nodeElement);
            });
            
            updateStatistics();
        }

        function renderDepartment(dept, isChild = false) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'org-node';
            
            const totalStaff = dept.positions ? dept.positions.reduce((sum, pos) => sum + pos.staffCount, 0) : 0;
            const gradeRange = dept.positions && dept.positions.length > 0 ? 
                `${Math.min(...dept.positions.map(p => p.grade))}-${Math.max(...dept.positions.map(p => p.grade))}` : '';
            const hasChildren = dept.children && dept.children.length > 0;
            const collapseIcon = hasChildren ? (dept.collapsed ? '‚ñ∂' : '‚ñº') : '';
            const minGrade = dept.positions && dept.positions.length > 0 ? Math.min(...dept.positions.map(p => p.grade)) : 1;

            nodeDiv.innerHTML = `
                <div class="bg-white border-2 border-gray-200 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-200 ${getGradeClass(minGrade)}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                ${hasChildren ? `<button onclick="toggleCollapse('${dept.id}')" class="text-gray-500 hover:text-gray-700 font-bold text-sm w-5 h-5 flex items-center justify-center transition-colors">${collapseIcon}</button>` : '<div class="w-5"></div>'}
                                <h3 class="font-bold text-lg text-gray-800 leading-tight">${dept.name}</h3>
                            </div>
                            ${dept.head ? `<p class="text-sm text-gray-600 mt-1 ml-7">üë§ ${dept.head}</p>` : ''}
                        </div>
                        <div class="flex gap-1 ml-2 opacity-80 hover:opacity-100 transition-opacity">
                            <button onclick="addChildDepartment('${dept.id}')" class="bg-green-500 hover:bg-green-600 text-white p-1.5 rounded text-xs transition-colors" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ">
                                ‚ûï
                            </button>
                            <button onclick="editDepartment('${dept.id}')" class="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded text-xs transition-colors" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteDepartment('${dept.id}')" class="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded text-xs transition-colors" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-2 mb-3 ml-7">
                        ${gradeRange ? `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">–ì—Ä–µ–π–¥—ã ${gradeRange}</span>` : ''}
                        <span class="bg-orange-100 text-orange-800 text-xs font-semibold px-2 py-1 rounded-full">
                            üë• ${totalStaff} —á–µ–ª.
                        </span>
                        <span class="bg-gray-100 text-gray-800 text-xs font-semibold px-2 py-1 rounded-full">
                            üìã ${dept.positions ? dept.positions.length : 0} –ø–æ–∑.
                        </span>
                    </div>
                    
                    ${dept.description ? `<p class="text-sm text-gray-600 mb-3 ml-7 italic">${dept.description}</p>` : ''}
                    
                    ${dept.positions && dept.positions.length > 0 ? `
                        <div class="ml-7 bg-gray-50 rounded-lg p-3">
                            <div class="text-xs font-semibold text-gray-700 mb-2">–ü–æ–∑–∏—Ü–∏–∏:</div>
                            <div class="space-y-2">
                                ${dept.positions.map(pos => `
                                    <div class="flex items-center gap-2 text-xs flex-wrap bg-white rounded px-2 py-1">
                                        <span class="font-medium text-gray-800">${pos.title}</span>
                                        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">–ì—Ä.${pos.grade}</span>
                                        <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full">${pos.personnelType}</span>
                                        <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">${pos.personnelKind}</span>
                                        <span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">${pos.staffCount} —á–µ–ª.</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (hasChildren && !dept.collapsed) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = `org-children ${dept.children.length === 1 ? 'single-child' : ''}`;
                
                dept.children.forEach(child => {
                    const childElement = renderDepartment(child, true);
                    childrenContainer.appendChild(childElement);
                });
                
                nodeDiv.appendChild(childrenContainer);
            }
            
            return nodeDiv;
        }

        function toggleGradeView() {
            gradeViewActive = !gradeViewActive;
            const gradeView = document.getElementById('gradeView');
            const treeView = document.getElementById('orgChart');
            
            if (gradeViewActive) {
                gradeView.classList.remove('hidden');
                treeView.classList.add('hidden');
                renderGradeView();
            } else {
                gradeView.classList.add('hidden');
                treeView.classList.remove('hidden');
            }
        }

        function renderGradeView() {
            const container = document.getElementById('gradeGroups');
            container.innerHTML = '';

            const gradeGroups = {};
            
            function collectPositions(structure) {
                structure.forEach(dept => {
                    if (dept.positions) {
                        dept.positions.forEach(pos => {
                            const gradeRange = getGradeRange(pos.grade);
                            if (!gradeGroups[gradeRange]) {
                                gradeGroups[gradeRange] = [];
                            }
                            gradeGroups[gradeRange].push({
                                ...pos,
                                departmentName: dept.name
                            });
                        });
                    }
                    
                    if (dept.children) {
                        collectPositions(dept.children);
                    }
                });
            }

            collectPositions(orgStructure);

            const ranges = ['1-5', '6-10', '11-15', '16-20', '21-25', '26-30'];
            const titles = ['–°—Ç–∞–∂–µ—Ä—ã/–ú–ª–∞–¥—à–∏–µ', '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã', '–°—Ç–∞—Ä—à–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã', '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ –≥—Ä—É–ø–ø', '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã', '–¢–æ–ø-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç'];
            
            ranges.forEach((range, index) => {
                if (gradeGroups[range] && gradeGroups[range].length > 0) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'mb-6';
                    
                    groupDiv.innerHTML = `
                        <h3 class="text-xl font-bold mb-3 text-gray-800">
                            ${titles[index]} (–ì—Ä–µ–π–¥—ã ${range})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${gradeGroups[range].map(pos => `
                                <div class="bg-white border-2 border-gray-200 rounded-lg p-4 ${getGradeClass(pos.grade)}">
                                    <h4 class="font-semibold text-gray-800">${pos.title}</h4>
                                    <p class="text-sm text-gray-600">üìç ${pos.departmentName}</p>
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">
                                            –ì—Ä–µ–π–¥ ${pos.grade}
                                        </span>
                                        <span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded">
                                            ${pos.personnelType}
                                        </span>
                                        <span class="bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-1 rounded">
                                            ${pos.personnelKind}
                                        </span>
                                        <span class="bg-orange-100 text-orange-800 text-xs font-semibold px-2 py-1 rounded">
                                            üë• ${pos.staffCount} —á–µ–ª.
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    container.appendChild(groupDiv);
                }
            });
        }

        function getGradeRange(grade) {
            if (grade <= 5) return '1-5';
            if (grade <= 10) return '6-10';
            if (grade <= 15) return '11-15';
            if (grade <= 20) return '16-20';
            if (grade <= 25) return '21-25';
            return '26-30';
        }

        function updateStatistics() {
            const stats = {
                totalDepartments: 0,
                totalPositions: 0,
                totalStaff: 0,
                gradeStats: {},
                personnelTypeStats: { '–ê–£–ü': 0, '–ü–ü': 0 },
                personnelKindStats: { '—à—Ç–∞—Ç': 0, '–∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥': 0 }
            };

            function collectStats(structure) {
                structure.forEach(dept => {
                    stats.totalDepartments++;
                    
                    if (dept.positions) {
                        dept.positions.forEach(pos => {
                            stats.totalPositions++;
                            stats.totalStaff += pos.staffCount;
                            
                            const gradeRange = getGradeRange(pos.grade);
                            stats.gradeStats[gradeRange] = (stats.gradeStats[gradeRange] || 0) + pos.staffCount;
                            
                            stats.personnelTypeStats[pos.personnelType] += pos.staffCount;
                            stats.personnelKindStats[pos.personnelKind] += pos.staffCount;
                        });
                    }
                    
                    if (dept.children) {
                        collectStats(dept.children);
                    }
                });
            }

            collectStats(orgStructure);

            const statsContainer = document.getElementById('statistics');
            statsContainer.innerHTML = `
                <div class="font-semibold text-blue-800">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</div>
                <div>üìä –í—Å–µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π: ${stats.totalDepartments}</div>
                <div>üìã –í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: ${stats.totalPositions}</div>
                <div>üë• –û–±—â–∞—è —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å: ${stats.totalStaff}</div>
                
                <div class="font-semibold text-blue-800 mt-2">–ü–æ –≥—Ä–µ–π–¥–∞–º:</div>
                ${Object.entries(stats.gradeStats).map(([range, count]) => 
                    `<div>‚Ä¢ ${range}: ${count} —á–µ–ª.</div>`
                ).join('')}
                
                <div class="font-semibold text-blue-800 mt-2">–ü–æ —Ç–∏–ø—É –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:</div>
                <div>‚Ä¢ –ê–£–ü: ${stats.personnelTypeStats['–ê–£–ü']} —á–µ–ª.</div>
                <div>‚Ä¢ –ü–ü: ${stats.personnelTypeStats['–ü–ü']} —á–µ–ª.</div>
                
                <div class="font-semibold text-blue-800 mt-2">–ü–æ –≤–∏–¥—É –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:</div>
                <div>‚Ä¢ –®—Ç–∞—Ç: ${stats.personnelKindStats['—à—Ç–∞—Ç']} —á–µ–ª.</div>
                <div>‚Ä¢ –ê—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥: ${stats.personnelKindStats['–∞—É—Ç—Å—Ç–∞—Ñ—Ñ–∏–Ω–≥']} —á–µ–ª.</div>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        renderTree();
        updateStatistics();
    </script>
</body>
</html> '–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                    grade: '30',
                    personnelType: '–ê–£–ü',
                    personnelKind: '—à—Ç–∞—Ç',
                    staffCount: '1'
                },
                {
                    deptId: '2',
                    parentId: '1',
                    deptName: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
                    description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –∏ –±—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º',
                    head: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä',
                    positionTitle:
